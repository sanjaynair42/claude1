<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce OAuth Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #dc3545;
            margin-bottom: 30px;
        }
        
        .diagnostic-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .diagnostic-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .fix-section {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .fix-section h3 {
            color: #721c24;
            margin-bottom: 15px;
        }
        
        .test-section {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            background: #007cff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .code-block {
            background: #263238;
            color: #4fc3f7;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .checklist {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .checklist li {
            margin: 8px 0;
            color: #155724;
        }
        
        .step-number {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Salesforce OAuth Error Diagnostics</h1>
            <p>Scope Error: "the requested scope is not available"</p>
        </div>
        
        <!-- Problem Analysis -->
        <div class="diagnostic-section">
            <h3>üîç Problem Analysis</h3>
            <p>The <code>invalid_scope</code> error means your Salesforce org is rejecting the OAuth scopes in your request. This can happen for several reasons:</p>
            
            <ul>
                <li><strong>Connected App settings changed</strong> - Someone modified your Connected App</li>
                <li><strong>Org-level OAuth policies</strong> - Your Salesforce org has restrictions</li>
                <li><strong>License limitations</strong> - Your org type doesn't support certain scopes</li>
                <li><strong>Security settings</strong> - New security policies were applied</li>
            </ul>
        </div>
        
        <!-- Immediate Fix -->
        <div class="fix-section">
            <h3><span class="step-number">1</span>Immediate Fix - Check Your Connected App</h3>
            
            <div class="checklist">
                <h4>Go to Salesforce Setup ‚Üí Apps ‚Üí App Manager ‚Üí Your Connected App ‚Üí Edit</h4>
                <ul>
                    <li>‚úÖ <strong>Enable OAuth Settings:</strong> Must be checked</li>
                    <li>‚úÖ <strong>Callback URL:</strong> https://sanjaynair42.github.io/claude1/</li>
                    <li>‚úÖ <strong>Selected OAuth Scopes:</strong> ONLY these two:
                        <ul>
                            <li>Access and manage your data (api)</li>
                            <li>Perform requests on your behalf at any time (refresh_token, offline_access)</li>
                        </ul>
                    </li>
                    <li>‚ùå <strong>Require secret for Web Server Flow:</strong> UNCHECKED</li>
                    <li>‚ùå <strong>Require secret for Refresh Token Flow:</strong> UNCHECKED</li>
                    <li>‚úÖ <strong>IP Relaxation:</strong> Relax IP restrictions</li>
                </ul>
            </div>
        </div>
        
        <!-- Alternative Approach -->
        <div class="fix-section">
            <h3><span class="step-number">2</span>Alternative - Create Minimal Connected App</h3>
            
            <p>If the above doesn't work, create a completely new Connected App:</p>
            
            <div class="code-block">
Connected App Name: Minimal OAuth Test
API Name: Minimal_OAuth_Test
Contact Email: your.email@domain.com

‚úÖ Enable OAuth Settings
Callback URL: https://sanjaynair42.github.io/claude1/

Selected OAuth Scopes (ONLY ONE):
‚úÖ Access and manage your data (api)

Security Settings:
‚ùå ALL boxes UNCHECKED
‚úÖ IP Relaxation: Relax IP restrictions
            </div>
        </div>
        
        <!-- Testing Interface -->
        <div class="test-section">
            <h3><span class="step-number">3</span>Test Different Approaches</h3>
            
            <div class="form-group">
                <label for="environment">Environment:</label>
                <select id="environment">
                    <option value="https://login.salesforce.com">Production</option>
                    <option value="https://test.salesforce.com">Sandbox</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="clientId">Consumer Key:</label>
                <input type="text" id="clientId" placeholder="3MVG9..." style="font-family: monospace;">
            </div>
            
            <h4>Try These Tests (in order):</h4>
            
            <button class="btn" onclick="testBasicScope()">Test 1: Basic API Scope</button>
            <button class="btn" onclick="testIdScope()">Test 2: ID Only Scope</button>
            <button class="btn" onclick="testWebScope()">Test 3: Web Scope</button>
            <button class="btn btn-warning" onclick="testNoScope()">Test 4: No Scope</button>
            
            <div id="testResults"></div>
        </div>
        
        <!-- Success Section -->
        <div id="successSection" style="display: none;">
            <div class="status success">
                üéâ SUCCESS! One of the scope tests worked.
            </div>
            
            <div class="test-section">
                <h3>üìä Now Test API Access</h3>
                <button class="btn btn-success" onclick="testApiCall()">Test Salesforce API</button>
                <div id="apiResults"></div>
            </div>
        </div>
        
        <!-- Troubleshooting -->
        <div class="diagnostic-section">
            <h3>üõ†Ô∏è If All Tests Fail</h3>
            
            <p><strong>Your Salesforce org may have very restrictive OAuth policies. Try these:</strong></p>
            
            <ul>
                <li><strong>Use a Sandbox:</strong> Create the Connected App in a Sandbox environment</li>
                <li><strong>Contact your admin:</strong> Your org may have custom OAuth restrictions</li>
                <li><strong>Try Developer Edition:</strong> Sign up for a free Salesforce Developer org at developer.salesforce.com</li>
                <li><strong>Check org settings:</strong> Setup ‚Üí Security ‚Üí Session Settings ‚Üí OAuth policies</li>
            </ul>
        </div>
    </div>

    <script>
        var accessToken = '';
        var instanceUrl = '';

        document.addEventListener('DOMContentLoaded', function() {
            checkOAuthReturn();
        });

        function checkOAuthReturn() {
            var urlParams = new URLSearchParams(window.location.search);
            var hash = window.location.hash.substring(1);
            var hashParams = new URLSearchParams(hash);
            
            var error = urlParams.get('error') || hashParams.get('error');
            if (error) {
                var errorMessage = '‚ùå OAuth Error Details:\n\n';
                errorMessage += 'Error: ' + error + '\n';
                
                var description = urlParams.get('error_description') || hashParams.get('error_description');
                if (description) {
                    errorMessage += 'Description: ' + decodeURIComponent(description) + '\n\n';
                }
                
                if (error === 'invalid_scope') {
                    errorMessage += 'üîß SPECIFIC FIXES FOR SCOPE ERROR:\n';
                    errorMessage += '1. Remove ALL scopes except "api" from your Connected App\n';
                    errorMessage += '2. Uncheck "Require secret for Web Server Flow"\n';
                    errorMessage += '3. Wait 15 minutes after making changes\n';
                    errorMessage += '4. Try the scope tests above';
                }
                
                showStatus(errorMessage, 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            var code = urlParams.get('code');
            var token = hashParams.get('access_token');
            var instance = hashParams.get('instance_url');
            
            if (code) {
                showStatus('‚úÖ SUCCESS! Authorization code received: ' + code.substring(0, 20) + '...', 'success');
                showSuccessSection();
            } else if (token && instance) {
                accessToken = token;
                instanceUrl = instance;
                showStatus('‚úÖ SUCCESS! Access token received!', 'success');
                showSuccessSection();
            }
            
            if (code || token) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function testBasicScope() {
            runScopeTest('api', 'Basic API access - most common scope');
        }

        function testIdScope() {
            runScopeTest('id', 'Identity only - minimal permissions');
        }

        function testWebScope() {
            runScopeTest('web', 'Web access - alternative to API');
        }

        function testNoScope() {
            runScopeTest('', 'No scope specified - lets Salesforce decide');
        }

        function runScopeTest(scope, description) {
            var clientId = document.getElementById('clientId').value;
            var environment = document.getElementById('environment').value;
            
            if (!clientId) {
                showStatus('Please enter your Consumer Key', 'error');
                return;
            }
            
            showStatus('üîÑ Testing: ' + description + '\nScope: "' + scope + '"\nRedirecting...', 'info');
            
            var params = new URLSearchParams({
                response_type: 'token',
                client_id: clientId,
                redirect_uri: 'https://sanjaynair42.github.io/claude1/',
                state: 'test_' + Date.now()
            });
            
            if (scope) {
                params.set('scope', scope);
            }
            
            var oauthUrl = environment + '/services/oauth2/authorize?' + params;
            
            setTimeout(function() {
                window.location.href = oauthUrl;
            }, 2000);
        }

        function showSuccessSection() {
            document.getElementById('successSection').style.display = 'block';
        }

        function testApiCall() {
            if (!accessToken) {
                showApiResult('‚ùå No access token available', 'error');
                return;
            }
            
            fetch(instanceUrl + '/services/data/', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            })
            .then(function(data) {
                showApiResult('‚úÖ API Access Works!\n\nAvailable API versions: ' + data.length + '\nLatest version: ' + (data[data.length - 1] ? data[data.length - 1].version : 'Unknown'), 'success');
            })
            .catch(function(error) {
                showApiResult('‚ö†Ô∏è Limited API access: ' + error.message + '\n\nOAuth worked, but API permissions may be limited.', 'info');
            });
        }

        function showApiResult(message, type) {
            var resultDiv = document.createElement('div');
            resultDiv.className = 'status ' + type;
            resultDiv.textContent = message;
            
            var container = document.getElementById('apiResults');
            container.innerHTML = '';
            container.appendChild(resultDiv);
        }

        function showStatus(message, type) {
            var statusDiv = document.createElement('div');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
            
            var container = document.getElementById('testResults');
            container.appendChild(statusDiv);
            
            if (type === 'info') {
                setTimeout(function() {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 10000);
            }
        }
    </script>
</body>
</html>
