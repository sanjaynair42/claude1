<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Basic OAuth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header {
            text-align: center;
            color: #0070d2;
            margin-bottom: 30px;
        }
        
        .critical-fix {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .critical-fix h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .scope-fix {
            background: #f8d7da;
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .scope-fix h4 {
            color: #721c24;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            background: #0070d2;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #005fb2;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .test-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .scope-option {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .scope-option:hover {
            border-color: #0070d2;
            background: #f0f8ff;
        }
        
        .code-block {
            background: #263238;
            color: #4fc3f7;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Salesforce OAuth Scope Troubleshooter</h1>
            <p>Let's fix your scope error step by step</p>
        </div>
        
        <!-- Critical Fix Section -->
        <div class="critical-fix">
            <h3>üö® IMMEDIATE FIX REQUIRED</h3>
            <p>The scope error means your Connected App has scopes that aren't available. Here's what to do:</p>
            
            <div class="scope-fix">
                <h4>üîÑ Create BRAND NEW Connected App</h4>
                <ol>
                    <li><strong>Delete your current Connected App</strong> (it might have bad scope settings)</li>
                    <li><strong>Create new one</strong> with these EXACT settings:</li>
                </ol>
                
                <div class="code-block">
                Connected App Name: Test App Basic
                API Name: Test_App_Basic
                Contact Email: your.email@domain.com

                ‚úÖ Enable OAuth Settings

                Callback URL: https://sanjaynair42.github.io/claude1/

                Selected OAuth Scopes (ONLY ONE):
                ‚úÖ Access and manage your data (api)

                CRITICAL:
                ‚ùå Require Secret for Web Server Flow: UNCHECKED
                ‚ùå Require Secret for Refresh Token Flow: UNCHECKED
                ‚úÖ IP Relaxation: Relax IP restrictions
                </div>
            </div>
            
            <p><strong>‚è∞ After creating: Wait 15 minutes before testing!</strong></p>
        </div>
        
        <!-- Testing Form -->
        <div class="form-group">
            <label for="environment">Environment:</label>
            <select id="environment">
                <option value="https://login.salesforce.com">Production</option>
                <option value="https://test.salesforce.com">Sandbox</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="clientId">Consumer Key (from NEW Connected App):</label>
            <input type="text" id="clientId" placeholder="3MVG9..." style="font-family: monospace;">
        </div>
        
        <!-- Scope Tests -->
        <div class="test-section">
            <h3>üß™ Progressive Scope Testing</h3>
            <p>Try these in order - if one fails, try the next:</p>
            
            <div class="scope-option" onclick="testScope('id')">
                <h4>1. Test: ID Only (Most Basic)</h4>
                <p><strong>Scope:</strong> <code>id</code></p>
                <p>Just gets your user ID - should work on any org</p>
                <button class="btn" onclick="event.stopPropagation(); testScope('id')">Test ID Scope</button>
            </div>
            
            <div class="scope-option" onclick="testScope('api')">
                <h4>2. Test: API Access</h4>
                <p><strong>Scope:</strong> <code>api</code></p>
                <p>Basic API access - what we need for Salesforce operations</p>
                <button class="btn" onclick="event.stopPropagation(); testScope('api')">Test API Scope</button>
            </div>
            
            <div class="scope-option" onclick="testScope('web')">
                <h4>3. Test: Web Access</h4>
                <p><strong>Scope:</strong> <code>web</code></p>
                <p>Web-based access - sometimes works when API doesn't</p>
                <button class="btn" onclick="event.stopPropagation(); testScope('web')">Test Web Scope</button>
            </div>
            
            <div class="scope-option" onclick="testScope('openid')">
                <h4>4. Test: OpenID</h4>
                <p><strong>Scope:</strong> <code>openid</code></p>
                <p>Basic identity - minimal permissions</p>
                <button class="btn" onclick="event.stopPropagation(); testScope('openid')">Test OpenID Scope</button>
            </div>
        </div>
        
        <div id="statusMessages"></div>
        
        <!-- Success Section -->
        <div id="successSection" class="hidden">
            <div class="status success">
                üéâ SUCCESS! OAuth worked with minimal scope.
            </div>
            
            <div class="test-section">
                <h3>üìä Now Test API Access</h3>
                <button class="btn btn-success" onclick="testBasicApi()">Test Basic API Call</button>
                <div id="apiResults"></div>
            </div>
            
            <button class="btn btn-danger" onclick="startOver()">üîÑ Start Over</button>
        </div>
    </div>

    <script>
        let accessToken = '';
        let instanceUrl = '';

        document.addEventListener('DOMContentLoaded', function() {
            checkOAuthReturn();
        });

        function checkOAuthReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            
            // Check for errors
            const error = urlParams.get('error') || hashParams.get('error');
            if (error) {
                let errorMessage = `‚ùå Still getting scope error: ${error}`;
                const description = urlParams.get('error_description') || hashParams.get('error_description');
                
                if (description) {
                    errorMessage += `\n\nDescription: ${decodeURIComponent(description)}`;
                }
                
                if (error === 'invalid_scope') {
                    errorMessage += `\n\nüîß NEXT STEPS:\n1. Your org might have very restricted scopes\n2. Try creating the Connected App in a Sandbox instead\n3. Contact your Salesforce admin\n4. Or try the most basic scope tests above`;
                }
                
                showStatus(errorMessage, 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Check for success
            const code = urlParams.get('code');
            const token = hashParams.get('access_token');
            const instance = hashParams.get('instance_url');
            
            if (code) {
                showStatus(`‚úÖ SUCCESS! Got authorization code: ${code.substring(0, 20)}...\n\nYour scope issue is FIXED!`, 'success');
                showSuccessSection();
            } else if (token && instance) {
                accessToken = token;
                instanceUrl = instance;
                showStatus('‚úÖ SUCCESS! Got access token directly!\n\nYour scope issue is FIXED!', 'success');
                showSuccessSection();
            }
            
            if (code || token) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function testScope(scopeType) {
            const clientId = document.getElementById('clientId').value;
            const environment = document.getElementById('environment').value;
            
            if (!clientId) {
                showStatus('‚ùå Please enter your Consumer Key from the NEW Connected App', 'error');
                return;
            }
            
            if (clientId.length < 70) {
                showStatus('‚ùå Consumer Key looks too short. Make sure you copied it completely.', 'error');
                return;
            }
            
            const scopeMap = {
                'id': 'id',
                'api': 'api',
                'web': 'web',
                'openid': 'openid'
            };
            
            const scope = scopeMap[scopeType] || 'id';
            
            showStatus(`üîÑ Testing scope: "${scope}"\n\nRedirecting to Salesforce...`, 'info');
            
            // Use implicit flow for immediate results
            const params = new URLSearchParams({
                response_type: 'token',
                client_id: clientId,
                redirect_uri: 'https://sanjaynair42.github.io/claude1/',
                scope: scope,
                state: `${scopeType}_${Date.now()}`
            });
            
            const oauthUrl = `${environment}/services/oauth2/authorize?${params}`;
            
            console.log(`Testing scope: ${scope}`);
            console.log(`OAuth URL: ${oauthUrl}`);
            
            setTimeout(() => {
                window.location.href = oauthUrl;
            }, 2000);
        }

        function showSuccessSection() {
            document.getElementById('successSection').classList.remove('hidden');
        }

        async function testBasicApi() {
            if (!accessToken) {
                showApiResult('‚ùå No access token available', 'error');
                return;
            }
            
            try {
                // Try the most basic API call
                const response = await fetch(`${instanceUrl}/services/data/`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showApiResult(`‚úÖ API Access Works!\n\nAvailable API versions: ${data.length}\nLatest version: ${data[data.length - 1]?.version || 'Unknown'}`, 'success');
                } else {
                    const errorText = await response.text();
                    showApiResult(`‚ö†Ô∏è Limited API access (HTTP ${response.status})\n\nThis might be due to minimal scope, but OAuth is working!\n\nError: ${errorText}`, 'info');
                }
            } catch (error) {
                showApiResult(`‚ùå API test failed: ${error.message}\n\nBut OAuth worked, so the scope issue is resolved!`, 'info');
            }
        }

        function showApiResult(message, type) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.textContent = message;
            
            const container = document.getElementById('apiResults');
            container.innerHTML = '';
            container.appendChild(resultDiv);
        }

        function startOver() {
            accessToken = '';
            instanceUrl = '';
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('statusMessages').innerHTML = '';
            document.getElementById('clientId').value = '';
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            const container = document.getElementById('statusMessages');
            container.appendChild(statusDiv);
            
            if (type === 'info') {
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 10000);
            }
        }
    </script>
</body>
</html>
